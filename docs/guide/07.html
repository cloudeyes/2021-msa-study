

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>07. Aggregates and Consistency Boundaries &mdash; 2021 Microservices Architecture Study  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="config" href="../config.html" />
    <link rel="prev" title="06. Unit of Work Pattern" href="06.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 2021 Microservices Architecture Study
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00.html">00. Kick-Off</a></li>
<li class="toctree-l1"><a class="reference internal" href="01.html">01. Domain Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="02.html">02. Repository Pattern</a></li>
<li class="toctree-l1"><a class="reference internal" href="03.html">03. Coupling and Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="04.html">04. Flask API and Service Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="05.html">05. TDD in High and Low Gears</a></li>
<li class="toctree-l1"><a class="reference internal" href="06.html">06. Unit of Work Pattern</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">07. Aggregates and Consistency Boundaries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Sanity-Checks-for-the-project">Sanity Checks for the project</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Project-structure">Project structure</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#테스트-피라미드는?">테스트 피라미드는?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Why-Not-Just-Run-Everything-in-a-Spreadsheet?">Why Not Just Run Everything in a Spreadsheet?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Invariants,-Constraints,-and-Consistency">Invariants, Constraints, and Consistency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Invariants,-Concurrency,-and-Locks">Invariants, Concurrency, and Locks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#What-Is-an-Aggregate?">What Is an Aggregate?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Choosing-an-Aggregate">Choosing an Aggregate</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Product-Aggregate를-코드로-작성하기"><code class="docutils literal notranslate"><span class="pre">Product</span></code> Aggregate를 코드로 작성하기</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#AGGREGATES,-BOUNDED-CONTEXTS,-AND-MICROSERVICES">AGGREGATES, BOUNDED CONTEXTS, AND MICROSERVICES</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#One-Aggregate-=-One-Repository">One Aggregate = One Repository</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#테스트를-통해-Aggregate-도메인-모델-사용법-익히기">테스트를 통해 Aggregate 도메인 모델 사용법 익히기</a></li>
<li class="toctree-l3"><a class="reference internal" href="#레포지터리와-UoW-사용해보기">레포지터리와 UoW 사용해보기</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#What-About-Performance?">What About Performance?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Optimistic-Concurrency-with-Version-Numbers">Optimistic Concurrency with Version Numbers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#특정-품목의-배치들에-대해서만-락-걸기">특정 품목의 배치들에 대해서만 락 걸기</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#OPTIMISTIC-CONCURRENCY-CONTROL-AND-RETRIES">OPTIMISTIC CONCURRENCY CONTROL AND RETRIES</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Implementation-Options-for-Version-Numbers">Implementation Options for Version Numbers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Testing-for-Our-Data-Integrity-Rules">Testing for Our Data Integrity Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Wrap-Up">Wrap-Up</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../domain.html">domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adapters.html">adapters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services.html">services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routes.html">routes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps.html">apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Library Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vendor.html">SQLAlchemy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vendor.html#flask">Flask</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">2021 Microservices Architecture Study</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../guide.html">Guide</a> &raquo;</li>
        
      <li>07. Aggregates and Consistency Boundaries</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/guide/07.ipynb" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="07.-Aggregates-and-Consistency-Boundaries">
<h1>07. Aggregates and Consistency Boundaries<a class="headerlink" href="#07.-Aggregates-and-Consistency-Boundaries" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Introduction">
<h2>Introduction<a class="headerlink" href="#Introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="Sanity-Checks-for-the-project">
<h3>Sanity Checks for the project<a class="headerlink" href="#Sanity-Checks-for-the-project" title="Permalink to this headline">¶</a></h3>
<div class="section" id="Project-structure">
<h4>Project structure<a class="headerlink" href="#Project-structure" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>tree app -I <span class="s1">&#39;__pycache__&#39;</span> --sort<span class="o">=</span>version
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">app</span>
├── __init__.py
├── __main__.py
├── <span class="ansi-blue-intense-fg ansi-bold">adapters</span>
│   ├── __init__.py
│   ├── orm.py
│   └── repository.py
├── <span class="ansi-blue-intense-fg ansi-bold">apps</span>
│   ├── __init__.py
│   ├── fastapi.py
│   └── flask.py
├── config.py
├── <span class="ansi-blue-intense-fg ansi-bold">domain</span>
│   ├── __init__.py
│   └── models.py
├── requirements.txt
├── <span class="ansi-blue-intense-fg ansi-bold">routes</span>
│   ├── __init__.py
│   └── flask.py
└── <span class="ansi-blue-intense-fg ansi-bold">services</span>
    ├── __init__.py
    ├── batch.py
    └── uow.py

5 directories, 17 files
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>mypy -p app --strict
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-green-intense-fg ansi-bold">Success: no issues found in 16 source files</span>
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>pylint app
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

--------------------------------------------------------------------
Your code has been rated at 10.00/10 (previous run: 10.00/10, +0.00)


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>pytest
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-bold">============================= test session starts ==============================</span>
platform linux -- Python 3.9.1, pytest-6.1.2, py-1.10.0, pluggy-0.13.1
rootdir: /home/ykkim/notebooks/2021-msa-study/07-aggregates-boundaries
plugins: flask-1.1.0, anyio-2.0.2
collected 32 items

tests/e2e/test_api.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                                  [  3%]</span>
tests/integration/test_orm.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                     [ 21%]</span>
tests/integration/test_repository.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                  [ 28%]</span>
tests/integration/test_uow.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                       [ 40%]</span>
tests/unit/test_allocate.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                         [ 53%]</span>
tests/unit/test_batch.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                       [ 81%]</span>
tests/unit/test_services.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                       [100%]</span>

<span class="ansi-green-fg">============================== </span><span class="ansi-green-intense-fg ansi-bold">32 passed</span><span class="ansi-green-fg"> in 1.06s</span><span class="ansi-green-fg"> ==============================</span>
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="테스트-피라미드는?">
<h3>테스트 피라미드는?<a class="headerlink" href="#테스트-피라미드는?" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">tests.utils</span> <span class="kn">import</span> <span class="n">get_test_counts</span><span class="p">,</span> <span class="n">show_test_pyramid</span>
<span class="n">test_counts</span> <span class="o">=</span> <span class="n">get_test_counts</span><span class="p">();</span> <span class="n">test_counts</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;unit&#39;: 20, &#39;integration&#39;: 12, &#39;e2e&#39;: 1}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">show_test_pyramid</span><span class="p">(</span><span class="n">test_counts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/guide_07_11_0.svg" src="../_images/guide_07_11_0.svg" /></div>
</div>
</div>
</div>
<div class="section" id="Why-Not-Just-Run-Everything-in-a-Spreadsheet?">
<h2>Why Not Just Run Everything in a Spreadsheet?<a class="headerlink" href="#Why-Not-Just-Run-Everything-in-a-Spreadsheet?" title="Permalink to this headline">¶</a></h2>
<p>이메일로 스프레드시트 파일을 교환하며 일하는 것은 흔한 방법입니다. 하지만 이 방법으로는 대규모 변경이나 제약조건을 케어하기 어렵습니다. 특히 이메일 수신자가 여러명이고 이 사용자들이 동시에 셀을 수정하거나 변경했다고 하면 변경 충돌을 제대로 병합할 수가 없습니다.</p>
<p>시스템의 제약 조건, 즉, 불변성(invariants)을 만족시킬 수 있는 작업이 필요합니다.</p>
<p><strong>[개인적인 생각]</strong></p>
<ul class="simple">
<li><p>스프레드시트에도 셀에 제약조건을 걸 수 있긴 합니다.</p></li>
<li><p>스프레드시트를 공유할 경우 셀에 동시에 여러 사용자가 수정하는 것을 방지할 수 있는 것으로 알고 있습니다.</p></li>
<li><p>하지만 이게 스프레드시트를 이메일로 공유하는 방식은 아니니까 넘어갑시다.</p></li>
</ul>
</div>
<div class="section" id="Invariants,-Constraints,-and-Consistency">
<h2>Invariants, Constraints, and Consistency<a class="headerlink" href="#Invariants,-Constraints,-and-Consistency" title="Permalink to this headline">¶</a></h2>
<p>이 책에서 계속 만들고 있는 MADE.COM(가구 리테일 시스템)의 비즈니스 규칙으로부터 불변 조건을 생각해봅시다.</p>
<blockquote>
<div><p>An order line can be allocated to only one batch at a time.</p>
</div></blockquote>
<p>한 주문선은 오직 한 배치에만 할당될 수 있다는 조건입니다. 즉 다음과 같은 관계를 암시합니다.</p>
<img alt="../images/orderline-relation.svg" src="../images/orderline-relation.svg" /><p>하지만 현재 <code class="docutils literal notranslate"><span class="pre">allocate</span></code> 서비스 함수에는 이런 제약조건의 유효성 검사 규칙이 없습니다. <code class="docutils literal notranslate"><span class="pre">can_allocate</span></code>를 만족하는 한, 동일한 <code class="docutils literal notranslate"><span class="pre">OrderLine</span></code>에 같은 배치를 여러번 할당 할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;주어진 배치들 중 할당 가능하고  가장 ETA가 빠른 배치를 주문선 `line`에 할당합니다.</span>

<span class="sd">    Raises:</span>
<span class="sd">        :class:`OutOfStock` 할당 가능한 배치가 없을 때 발생하는 예외.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
    <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>
</pre></div>
</div>
<p><strong>[의문점]</strong></p>
<ul class="simple">
<li><p>이럴거면 왜 <code class="docutils literal notranslate"><span class="pre">Batch</span></code> 와 <code class="docutils literal notranslate"><span class="pre">OrderLine</span></code> 관계를 N:M 구조로 모델링 했는지 이해할 수 없네요. 계속 살펴봅시다.</p></li>
</ul>
<div class="section" id="Invariants,-Concurrency,-and-Locks">
<h3>Invariants, Concurrency, and Locks<a class="headerlink" href="#Invariants,-Concurrency,-and-Locks" title="Permalink to this headline">¶</a></h3>
<p>동시성 문제가 더해지면 불변성 제약을 만족시키란 더 어려워집니다. 다음 비즈니스 규칙을 생각해봅시다.</p>
<blockquote>
<div><p>We can’t allocate to a batch if the available quantity is less than the quantity of the order line.</p>
</div></blockquote>
<p>위의 <code class="docutils literal notranslate"><span class="pre">allocate</span></code> 서비스 함수 구현을 보면 <code class="docutils literal notranslate"><span class="pre">can_allocate</span></code> 함수를 통해 이 조건에 대한 유효성 검사가 이뤄지고 있다는 것을 알 수 있습니다. 하지만 동시에 여러 작업이 처리되는 경우 할당 후 커밋 전에 다른 스레드/프로세스에서 재고가 있는 것으로 간주되어 중복으로 할당할 수 있습니다.</p>
<p>물론 DB 행이나 테이블에 락을 걸면 간단히 해결되는 경우도 있지만, 이 경우 락으로 인한 성능 저하가 발생합니다. 더 큰 문제점은 불변성 검사를 해야 하는 객체들이 늘어나면서 관리 복잡성이 증가하고 잘못된 락에 의한 데드락의 위험이 커지게 된다는 점입니다.</p>
<p>불변성을 만족해야 하는 객체들을 보다 효과적으로 관리할 방법이 있을까요?</p>
</div>
</div>
<div class="section" id="What-Is-an-Aggregate?">
<h2>What Is an Aggregate?<a class="headerlink" href="#What-Is-an-Aggregate?" title="Permalink to this headline">¶</a></h2>
<p>이런 문제를 해결하는 방법으로 DDD 커뮤니티에서는 <strong>Aggregate 패턴</strong> 을 제시합니다.</p>
<p>전체 데이터베이스에 락을 거는 대신, 불변성을 만족하는 논리적인 “덩어리”를 만드는 것입니다.</p>
<p>예를 들어 동일한 품목(SKU)을 여러 사용자가 동시에 할당하려 할경우 과할당 되는 동시성 문제가 발생 가능하지만 서로 다른 품목들을 동시에 할당하는 것은 문제가 발생하지 않습니다.</p>
<p>이런 동일 품목 단위의 객체들을 “덩어리(Aggregate)”로 뭉쳐서 별도의 모델로 정의하고 이 덩어리 모델에 대한 메소드를 호출하여 동시성 문제를 해결하고, 여러 객체간의 복잡한 상화작용을 단순화하며, 처리 성능을 최적화하는 것이 Aggregate 패턴의 핵심 아이디어 입니다.</p>
<p>유식한 말로 “불변성 지키는 책임을 가진 객체들이 모인 단일 일관성의 경계(a single consistency boundary)”를 찾는 것입니다. 쇼핑몰의 장바구니가 대표적인 예라고 할 수 있습니다.</p>
<p>에릭 에반스는 그의 저서인 DDD에서 다음과 같이 Aggregate를 정의합니다.</p>
<blockquote>
<div><p>An AGGREGATE is a cluster of associated objects that we treat as a unit for the purpose of data changes.</p>
<p>– Eric Evans, Domain-Driven Design blue book</p>
</div></blockquote>
</div>
<div class="section" id="Choosing-an-Aggregate">
<h2>Choosing an Aggregate<a class="headerlink" href="#Choosing-an-Aggregate" title="Permalink to this headline">¶</a></h2>
<p>그런데 이런 “단일 일관성 경계”를 어떻게 찾아내서 덩어리로 만들라는 말인가요?</p>
<p>일단 일관성을 지켜야 하는것이 명확해 보이는 객체들을 여러 크기와 종류의 덩어리로 만들어보고 그 덩어리에 적절한 이름(도메인 모델)을 붙인뒤 이름에 대한 작업이 우리가 원하는 일관성과 성능목표를 만족하는지 검토해 보는것입니다. (성능을 위해서 크기는 작을수록 좋습니다.)</p>
<p>예를 들어, 지금 우리가 중점을 두는것은 배치(Batch)들을 어떻게 각각의 일관성의 섬으로 군집화하냐는 것입니다. 배송(Shipment)단위나 창고 단위의 덩어리는 너무 크다는 것을 알 수 있습니다. 스푼 박스와 젓가락 박스는 다른 품목이기 때문에 여러 주문선들에 동시 할당이 가능한데, 창고 단위의 Aggregate의 경우 다른 주문선의 할당 완료를 기다려야 하기 때문입니다.</p>
<p>결론적으로 같은 품목끼리 일관성을 유지하는 군집화가 가장 합리적입니다. 그리고 이 덩어리를 가장 적절하게 붙일 수 있는 이름은 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 입니다.</p>
<p>사실 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 모델은 1장에서 도메인 언어를 모델링할 때 이미 살펴봤던 것입니다.</p>
<img alt="../images/domain-model.svg" src="../images/domain-model.svg" /><p>우리의 목표는 배치 도메인 모델들을 그대로 사용하여 할당하는 다음과 같은 방식을 개선하는 것입니다.</p>
<img alt="../images/before_aggregate.svg" src="../images/before_aggregate.svg" /><p>개선방법은 <code class="docutils literal notranslate"><span class="pre">Product</span></code> Aggregation 을 통해 동일 품목(SKU)의 할당을 책임지게 하는 것입니다. 기존의 <code class="docutils literal notranslate"><span class="pre">allocate(orderline,</span> <span class="pre">batches)</span></code> 대신 <code class="docutils literal notranslate"><span class="pre">aProduct.allocate(orderline)</span></code> 라는 메소드를 통해 품목 단위로 할당하도록 하는 것입니다.</p>
<img alt="../images/after_aggregate.svg" src="../images/after_aggregate.svg" /><div class="section" id="Product-Aggregate를-코드로-작성하기">
<h3><code class="docutils literal notranslate"><span class="pre">Product</span></code> Aggregate를 코드로 작성하기<a class="headerlink" href="#Product-Aggregate를-코드로-작성하기" title="Permalink to this headline">¶</a></h3>
<p>앞서 살펴봤던 것과 같이 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 는 품목별 배치들의 Aggregate이므로 동일 품목의 존재하는 모든 배치를 생성자 인수로 받습니다.</p>
<p>기존에 도메인 모델 모듈에 정의되었던 <code class="docutils literal notranslate"><span class="pre">models.allocate</span></code> 함수를 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 모델의 메소드로 옮기면 Aggregate가 완성됩니다.</p>
<p>[src/domain/models/product.py]</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">OutOfStock</span>

<span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>이렇게 정의된 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 는 우리가 일반적으로 도메인 모델링 할 때 생각하는 모델과 상당히 다릅니다.</p>
<p>가격이나, 상품설명, 사이즈 등의 정보가 전혀 없습니다. 그 이유는 제품 할당과 관련된 현재 컨텍스트에서 품목(SKU)을 제외한 제품의 다른 속성들은 불필요하기 때문입니다. 이처럼, 바운디드 컨텍스트(Bounded Contexts)의 힘은 앱 마다 달라지는 개념을 유연하게 다룰 수 있다는 점입니다.</p>
<div class="section" id="AGGREGATES,-BOUNDED-CONTEXTS,-AND-MICROSERVICES">
<h4>AGGREGATES, BOUNDED CONTEXTS, AND MICROSERVICES<a class="headerlink" href="#AGGREGATES,-BOUNDED-CONTEXTS,-AND-MICROSERVICES" title="Permalink to this headline">¶</a></h4>
<p>에릭 에반스와 DDD 커뮤니티가 가장 크게 기여한 것중 하나는 바로 <a class="reference external" href="https://martinfowler.com/bliki/BoundedContext.html">Bounded Context</a> 의 개념입니다.</p>
<p>비즈니스의 전체 의미를 하나의 모델로 캡쳐하기 힘든 문제를 극복하려는 시도에서 비롯한 것입니다.</p>
<p>예를 들어, 고객(customer)이라는 단어는 의미는 영업, 고객관리, 물류, 지원 부서 등에서 서로 다른 의미로 사용됩니다. 따라서 속성(attributes)들도 사용하는 곳에 따라 달라집니다. 심지어 단어의 의미가 컨텍스트에 따라 완전히 바꾸기도 하기 십상입니다. 따라서 고객이라는 모델로 전체 비즈니스를 커버하기란 불가능합니다.</p>
<p>각 컨텍스트 경계(Bounded Context)에 여러 모델을 두고 모델간의 변환(translation)을 명시적으로 다루도록 하는 편이 좋습니다.</p>
<p>이런 전략은 마이크로서비스에 매우 잘 들어맞습니다. 각 마이크로서비스는 “고객”이란 모델을 자유롭게 정의할 수 있기 때문이죠. 고객을 다루는 또다른 컨텍스트(마이크로서비스와) 통신할 때는, 자신의 다른 고객 모델로 어떻게 변환할지만 고려하면 됩니다.</p>
<p>배치 할당을 다룬 예제에서 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 모델은 <code class="docutils literal notranslate"><span class="pre">(sku,</span> <span class="pre">batches)</span></code>를 속성으로 가졌습니다. 반면 전자 상거래 컨텍스트에서의 <code class="docutils literal notranslate"><span class="pre">Product</span></code>는 <code class="docutils literal notranslate"><span class="pre">(sku,</span> <span class="pre">description,</span> <span class="pre">price</span> <span class="pre">...)</span></code> 등 다른 속성들을 갖게 될 것입니다.</p>
<p>마이크로서비스를 사용하지 않더라도 Aggregate를 정할때 핵심 고려사항은 그 Aggregate가 동작할 경계 컨텍스트(Bounded Context)틀 정하는 것입니다. 제한된 컨텍스트를 통해 Aggregate의 수를 줄이고 관리가능한 크기로 유지할 수 있습니다.</p>
</div>
</div>
</div>
<div class="section" id="One-Aggregate-=-One-Repository">
<h2>One Aggregate = One Repository<a class="headerlink" href="#One-Aggregate-=-One-Repository" title="Permalink to this headline">¶</a></h2>
<p>Aggregate 로 뭉질 엔티티들이 정해지면, 외부(다른 앱/또는 서비스)에 엔티티가 바로 노출되지 않고 Aggregate 단위로 노출되도록 규칙을 적용해야 합니다. 즉, 레포지터리가 Aggregate를 리턴하도록 변경해야 한다는 것입니다.</p>
<p>[services/uow.py]</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">unittest.mock</span> <span class="kn">import</span> <span class="n">MagicMock</span>
<span class="n">repository</span> <span class="o">=</span> <span class="n">MagicMock</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># [app/adapters/repository.py]</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ContextDecorator</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">ContextDecorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repository 패턴의 추상 인터페이스 입니다.&quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;레포지터리에 Aggregate 객체를 추가합니다.&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;주어진 레퍼런스 문자열에 해당하는 Aggregate 객체를 조회합니다.</span>

<span class="sd">        해당 Aggregate를 못 찾을 경우 ``None`` 을 리턴합니다.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="테스트를-통해-Aggregate-도메인-모델-사용법-익히기">
<h3>테스트를 통해 Aggregate 도메인 모델 사용법 익히기<a class="headerlink" href="#테스트를-통해-Aggregate-도메인-모델-사용법-익히기" title="Permalink to this headline">¶</a></h3>
<p>그럼 이 Aggregate와 레포지터리를 어떻게 사용해야 할까요?</p>
<p>Low Gear(저단 기어)를 사용하기 적합할 때입니다. 도메인 모델 테스트를 추가하며 도메인 모델에 대한 이해도를 높혀 봅시다.</p>
<p><code class="docutils literal notranslate"><span class="pre">tests/unit/test_allocate.py</span></code> 에 정의된 테스트들은 Aggregate 도입 전 <code class="docutils literal notranslate"><span class="pre">allocate</span></code> 서비스 함수를 테스트하는 테스트 케이스였습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_prefers_current_stock_batches_to_shipments</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;oref&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="p">[</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">shipment_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>
</pre></div>
</div>
<p>이 코드를 <code class="docutils literal notranslate"><span class="pre">Product</span></code> Aggregate의 메소드를 사용한 테스트로 바꿔봅시다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">tests</span> <span class="kn">import</span> <span class="n">mytest</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">allocate</span><span class="p">,</span> <span class="n">OrderLine</span><span class="p">,</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">OutOfStock</span>

<span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">tomorrow</span> <span class="o">=</span> <span class="n">today</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">later</span> <span class="o">=</span> <span class="n">tomorrow</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_prefers_current_stock_batches_to_shipments</span><span class="p">():</span>
    <span class="n">in_stock_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;in-stock-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">shipment_batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;shipment-batch&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">tomorrow</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="p">[</span><span class="n">in_stock_batch</span><span class="p">,</span> <span class="n">shipment_batch</span><span class="p">])</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;oref&quot;</span><span class="p">,</span> <span class="s2">&quot;RETRO-CLOCK&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">in_stock_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">90</span>
    <span class="k">assert</span> <span class="n">shipment_batch</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">==</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_prefers_current_stock_batches_to_shipments</span>
</pre></div></div>
</div>
<p>테스트가 잘 성공합니다.</p>
</div>
<div class="section" id="레포지터리와-UoW-사용해보기">
<h3>레포지터리와 UoW 사용해보기<a class="headerlink" href="#레포지터리와-UoW-사용해보기" title="Permalink to this headline">¶</a></h3>
<p>6장에서 만들었떤 UoW 모델과 테스트 코드입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">FakeUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">FakeRepository</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span> <span class="nf">test_add_batch</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">committed</span>
</pre></div>
</div>
<p>이 코드를 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 와 <code class="docutils literal notranslate"><span class="pre">AbstractProductRepository</span></code> 를 이용해 재작성해 봅시다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app.services.uow</span> <span class="kn">import</span> <span class="n">AbstractUnitOfWork</span>

<span class="k">class</span> <span class="nc">FakeProductRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">[</span><span class="n">Product</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">products</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Product</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Product</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FakeUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">products</span> <span class="o">=</span> <span class="n">FakeProductRepository</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
<p>변경된 코드는 쉽게 이해할 수 있습니다. 한가지 복잡해보이는 코드는 <code class="docutils literal notranslate"><span class="pre">get</span></code> 함수의 리턴문입니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="nb">next</span><span class="p">((</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_products</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>이 코드를 아래와 같이 이해하기 쉽게 재작성할 수 있습니다.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">found</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proudcts</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">sku</span><span class="p">]</span>
<span class="k">return</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">found</span> <span class="k">else</span> <span class="kc">None</span>
</pre></div>
</div>
<p>하지만 근본적인 차이점은 무엇일까요? 만일 <code class="docutils literal notranslate"><span class="pre">_products</span></code> 에 10억개의 제품이 있다고 한다면 위 코드는 10억개 원소를 가진 리스트를 메모리에 먼저 빌드합니다. 결과를 리턴하는에 엄청난 리소스와 시간을 낭비하게 됩니다. 반면에 <code class="docutils literal notranslate"><span class="pre">(p</span> <span class="pre">for</span> <span class="pre">p</span> <span class="pre">in</span> <span class="pre">...)</span></code> 문은 제너레이터와 <code class="docutils literal notranslate"><span class="pre">next</span></code> 이터레이터 메소드로 구현되어 메모리 로드 없이 최초 발견한 1개의 원소를 바로 리턴하도록 한 것입니다.</p>
<p>그런데 테스트를 해보면 실패합니다.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">services</span>
<span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_add_batch_for_new_product</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">committed</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
❌ <span class="ansi-red-intense-fg">test_add_batch_for_new_product</span>
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Traceback (most recent call last):
  File &#34;/home/ykkim/notebooks/2021-msa-study/07-aggregates-boundaries/app/services/batch.py&#34;, line 30, in add
    uow.batches.add(Batch(ref, sku, qty, eta))
AttributeError: &#39;FakeUnitOfWork&#39; object has no attribute &#39;batches&#39;
</pre></div></div>
</div>
<p>그 이유는 기존에 정의된 <code class="docutils literal notranslate"><span class="pre">services.batch.add</span></code> 함수에서 사용한 <code class="docutils literal notranslate"><span class="pre">AbstractUnitOfWork</span></code> 구현이 바뀌었기 때문입니다.</p>
<p>테스트가 성공하도록 서비스 함수 구현을 수정해 봅시다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app.services.batch</span> <span class="kn">import</span> <span class="n">InvalidSku</span>

<span class="k">def</span> <span class="nf">add_batch</span><span class="p">(</span><span class="n">ref</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">eta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">date</span><span class="p">],</span>
              <span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">product</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="n">product</span><span class="o">.</span><span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="n">orderid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qty</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidSku</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">batchref</span> <span class="o">=</span> <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">batchref</span>

<span class="n">services</span> <span class="o">=</span> <span class="n">MagicMock</span><span class="p">()</span>
<span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">add_batch</span>
<span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">allocate</span> <span class="o">=</span> <span class="n">allocate</span>
</pre></div>
</div>
</div>
<p>다시 테스트를 실행시키면 테스트가 정상적으로 동작함을 알 수 있습니다.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_add_batch_for_new_product</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CRUNCHY-ARMCHAIR&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="n">uow</span><span class="o">.</span><span class="n">committed</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_add_batch_for_new_product</span>
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_allocate_returns_allocation</span><span class="p">():</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">FakeUnitOfWork</span><span class="p">()</span>
    <span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="s2">&quot;o1&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPLICATED-LAMP&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">uow</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="n">result</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_allocate_returns_allocation</span>
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="What-About-Performance?">
<h2>What About Performance?<a class="headerlink" href="#What-About-Performance?" title="Permalink to this headline">¶</a></h2>
<p>Aggregate를 사용하는 이유 중 하나가 락킹 최소화를 통한 성능 향상이었으니 성능에 대해서도 살펴보겠습니다.</p>
<p>결론적으로 현재까지의 구현상에는 성능상의 문제점이 좀 보입니다. <code class="docutils literal notranslate"><span class="pre">Product</span></code> Aggregate 의 생성자 때문입니다.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>현재 구현에서는 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 생성시에 전체 배치가 로드되어 있어야 합니다. 어떤 품목에 대한 배치가 10억개가 있다고 가정하면 쉽게 상상이 갈 것입니다.</p>
<p>하지만 (저자의 말에 의하면) 실제 유즈케이스 상에서 품목당 배치는 많아야 수십개 이하라고 하며, 수 만개 이상 되더라도 <code class="docutils literal notranslate"><span class="pre">Batch</span></code> 모델의 속성이 몇개 안되어 로드하는데 큰 부하는 없다고 말합니다.</p>
<p>만일 시스템의 규모가 커져 많은 배치를 다루게 될경우 Lazy Loading 방식을 이용해 개선하면 될 것입니다. 그 경우에도 감당이 안된다면 Aggregate를 좀더 작은 단위로 세분화 하면 될 것입니다.</p>
</div>
<div class="section" id="Optimistic-Concurrency-with-Version-Numbers">
<h2>Optimistic Concurrency with Version Numbers<a class="headerlink" href="#Optimistic-Concurrency-with-Version-Numbers" title="Permalink to this headline">¶</a></h2>
<p>여기까지 로직 레벨에서 일관성의 경계를 책임지는 Aggregate를 만들고 사용하는 방법을 확인했습니다. 이제 실제 DB 레벨에서 데이터 정합성을 확보하는 방법을 살펴보겠습니다.</p>
<div class="section" id="특정-품목의-배치들에-대해서만-락-걸기">
<h3>특정 품목의 배치들에 대해서만 락 걸기<a class="headerlink" href="#특정-품목의-배치들에-대해서만-락-걸기" title="Permalink to this headline">¶</a></h3>
<p>품목별 배치를 <code class="docutils literal notranslate"><span class="pre">Product</span></code>로 묶기 전에는 여러 트랜잭션들이 할당을 처리하는 도중 동일 품목의 배치를 잘 못 할당하는 것을 막기 위해 <code class="docutils literal notranslate"><span class="pre">batch</span></code> 테이블 전체에 락을 거는 수밖에 없었습니다.</p>
<p>특정 품목에 대해서만 락을 걸기 위해서는 소프트웨어적인 락이 필요합니다. 가장 간단한 방법은 <code class="docutils literal notranslate"><span class="pre">version_number</span></code> 라는 상태 변경 마커를 하나 만들어 동시성 작업의 유일한 리소스로 만드는 것입니다. 여러 트랜잭션이 할당 서비스를 통해 배치 전체 상태를 읽어 할당 테이블을 업데이트 시도하는 경우, <code class="docutils literal notranslate"><span class="pre">version_number</span></code> 를 체크하여 둘 중 하나가 먼저 커밋한 경우 나머지 커밋 시도를 무효화 하여 일관성이 유지되도록 하는 것입니다.</p>
<img alt="../images/ch7-seq-diagram-1.svg" src="../images/ch7-seq-diagram-1.svg" /><p>위 시퀀스 다이어그램은 동시에 할당 작업을 시도하는 두 트랜잭션의 처리과정을 나타냅니다. 두 트랜잭션은 <code class="docutils literal notranslate"><span class="pre">version</span></code>이 <code class="docutils literal notranslate"><span class="pre">3</span></code>인 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 에 대해 동시에 <code class="docutils literal notranslate"><span class="pre">allocate</span></code> 메소드를 호출합니다. 둘 중 어느 트랜잭션이 먼저 수행될지는 알 수 없지만, 제품이 할당되는 시점에 한 트랜잭션에 의해 버전이 <code class="docutils literal notranslate"><span class="pre">4</span></code>로 올라갈 경우 다른 트랜잭션의 요청은 버전 불일치 체크를 통해 취소처리 할 수 있습니다.</p>
<div class="section" id="OPTIMISTIC-CONCURRENCY-CONTROL-AND-RETRIES">
<h4>OPTIMISTIC CONCURRENCY CONTROL AND RETRIES<a class="headerlink" href="#OPTIMISTIC-CONCURRENCY-CONTROL-AND-RETRIES" title="Permalink to this headline">¶</a></h4>
<p>이 교재에서 동시성을 제하는 방식을 “낙관적 동시성 제어” 라고 합니다. 두 사용자가 데이터베이스를 동시에 변경하려 할 때 모든것이 정상이라고 가정하는 방식입니다. 동시 변경이 충돌할 가능성이 낮기 때문에 동시 변경을 허용하고 문제가 발생시 확실히 통보받을 수 있도록 하는것입니다.</p>
<p>반면에 “비관적 동시성 제어” 방식에서는 항상 충돌이 발생한다는 가정하에 동시작업을 설계합니다. 따라서 모든 변경작업에 락을 걸어 안전을 보장해야 합니다. 배치 할당 예제에서 이 말은 모든 배치 테이블에 락을 걸거나 <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">FOR</span> <span class="pre">UPDATE</span></code> 문을 사용해서 조회된 전체 행에 대한 락을 걸어야 함을 의미합니다. 이 책에서는 성능상의 문제로 이런 방식을 사용하지 않는다고 가정했지만 실제 프로젝트에서는 성능 평가를 직접 해봐야 합니다.</p>
<p>성능상의 문제에도 불구하고 비관적 락킹은 변경 충돌을 원천적으로 차단하므로 장애 처리가 필요 없다는 장점이 있습니다. (물론 데드락의 발생을 고려해야 합니다) 반면 낙관적 락킹시에는 충돌로 인한 실패를 명시적으로 처리해야 합니다.</p>
<p>실패 처리의 일반적인 방법은 작업을 처음부터 다시 시도하는 것입니다. 대부분의 작업은 동시성 문제가 발생할 경우 이러한 방식으로 재시도할 수 있습니다.</p>
</div>
</div>
<div class="section" id="Implementation-Options-for-Version-Numbers">
<h3>Implementation Options for Version Numbers<a class="headerlink" href="#Implementation-Options-for-Version-Numbers" title="Permalink to this headline">¶</a></h3>
<p>버전 번호를 구현하는 방법에는 세가지 옵션이 있습니다.</p>
<ol class="arabic simple">
<li><p>도메인에서 처리하기: <code class="docutils literal notranslate"><span class="pre">Product.allocate()</span></code> 메소드가 버전 번호 증가를 책임집니다.</p></li>
<li><p>서비스 계층에서 처리하기: 엄밀히 말해 버전번호를 통한 동시성 제어는 도메인 관심사가 아닙니다. 따라서 서비스 레이어가 이 책임을 대신 맞는게 적합할 수 있습니다. 커밋 전에 버전 번호를 증가시키는 방식을 사용합니다.</p></li>
<li><p>UoW에서 처리하기: UoW가 커밋할 때 Aggregate들에 변경이 일어났다고 가정하고 레포지터리에 로드된 모든 <code class="docutils literal notranslate"><span class="pre">Product</span></code>의 버전 번호를 증가시키는 것입니다.</p></li>
</ol>
<p>3번의 경우 모든 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 버전이 동시에 올라간다 가정이 말이 안되기 때문에 제외하고, 2번의 경우는 서비스 레이어와 도메인 레이어간의 상태 변경의 책임이 섞여 다소 혼란스럽습니다.</p>
<p>따라서 가장 깔끔한 절충안은 그냥 도메인에 버전 관리 책임을 두는 것입니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">Product</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">batches</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">],</span> <span class="n">version_number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sku</span> <span class="o">=</span> <span class="n">sku</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">=</span> <span class="n">version_number</span>

    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="n">OrderLine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                <span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">can_allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">batch</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_number</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">batch</span><span class="o">.</span><span class="n">reference</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">OutOfStock</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Out of stock for sku </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">sku</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="Testing-for-Our-Data-Integrity-Rules">
<h2>Testing for Our Data Integrity Rules<a class="headerlink" href="#Testing-for-Our-Data-Integrity-Rules" title="Permalink to this headline">¶</a></h2>
<p>이제 DB에서 우리가 만든 동시성 제어 방식이 제대로 동작하는지 테스트해볼 차례입니다.</p>
<p>먼저 ORM 에서 Aggregate 객체를 인식하도록 매핑을 추가합니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">ForeignKey</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">app.adapters</span> <span class="kn">import</span> <span class="n">orm</span>
<span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">OrderLine</span>

<span class="k">def</span> <span class="nf">start_mappers</span><span class="p">(</span><span class="n">use_exist</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MetaData</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">start_mappers</span><span class="p">(</span><span class="n">use_exist</span><span class="p">)</span> <span class="c1"># 기존 매퍼</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">]</span>
    <span class="n">order_line</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;order_line&#39;</span><span class="p">]</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;_purchased_quantity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;product.sku&#39;</span><span class="p">)),</span> <span class="c1"># 외래키 관계 추가</span>
              <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
              <span class="n">extend_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_order_line_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">,</span> <span class="n">order_line</span><span class="p">)</span>
    <span class="n">_batch_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">Batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;_allocations&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">allocation</span><span class="p">,</span>
                                     <span class="n">collection_class</span><span class="o">=</span><span class="nb">set</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">),</span>
    <span class="p">})</span>

    <span class="c1"># Aggregate 매핑 추가</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;version_number&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">),</span>
        <span class="n">extend_existing</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">prouct_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">Product</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;batches&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Batch</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">metadata</span>
</pre></div>
</div>
</div>
<p>이 매핑을 이용한 기본 Session 팩토리를 만듭니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">tests</span> <span class="kn">import</span> <span class="n">mytest</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span><span class="p">,</span> <span class="n">Session</span>
    <span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">config</span>
    <span class="n">orm</span><span class="o">.</span><span class="n">clear_mappers</span><span class="p">()</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">init_engine</span><span class="p">(</span><span class="n">start_mappers</span><span class="p">(),</span> <span class="n">config</span><span class="o">.</span><span class="n">get_db_url</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">DEFAULT_SESSION_FACTORY</span> <span class="o">=</span> <span class="n">get_session</span>
</pre></div>
</div>
</div>
<p>마지막으로 기존에 만들었더 SqlAlchemy ORM 기반의 레포지터리와 와 UoW를 Aggregate 를 사용한 구현으로 수정합니다</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">SqlAlchemyProductRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">[</span><span class="n">Product</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>  <span class="c1"># pylint: disable=invalid-name</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Product</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">AbstractUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_factory</span><span class="o">=</span><span class="n">DEFAULT_SESSION_FACTORY</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span> <span class="o">=</span> <span class="n">session_factory</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>  <span class="c1"># type: Session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">products</span> <span class="o">=</span> <span class="n">SqlAlchemyProductRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>우선 해야 할 작업은 트랜잭션 작업 사이에 Sleep을 두어 “느린” 트랜잭션을 흉내내보는 겁니다.</p>
<p>다음 <code class="docutils literal notranslate"><span class="pre">try_to_allocate</span></code> 함수는 앞에서 봤던 시퀀스 다이어그램에서 한 Transaction이 하던 작업과 유사한 작업을 합니다. 데이터베이스에서 제품 정보를 조회한 후, 제품을 할당하고, 제품의 버전을 증가시킵니다. 단, 버전을 증가시키는 작업은 <code class="docutils literal notranslate"><span class="pre">Product.allocate</span></code> 에서 암시적으로 이루어집니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">OrderLine</span>

<span class="k">def</span> <span class="nf">try_to_allocate</span><span class="p">(</span><span class="n">uow</span><span class="p">:</span> <span class="n">AbstractUnitOfWork</span><span class="p">,</span> <span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="n">orderid</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
            <span class="n">product</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span>
            <span class="n">product</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="n">uow</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># print(traceback.format_exc())</span>
        <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>테스트 픽스처 <code class="docutils literal notranslate"><span class="pre">uow_with_product</span></code>를 만들어 보겠습니다. 이 픽스쳐는 임의의 SKU로 테스트 데이터를 셋업한 뒤 UoW를 리턴합니다. 뿐만아니라 테스트가 끝나면 테스트 데이터를 자동으로 클리어 합니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">Batch</span>

<span class="kn">from</span> <span class="nn">tests</span> <span class="kn">import</span> <span class="n">random_batchref</span><span class="p">,</span> <span class="n">random_sku</span><span class="p">,</span> <span class="n">random_orderid</span>

<span class="k">def</span> <span class="nf">cleanup_sku</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">sku</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DELETE FROM allocation WHERE batch_id in (</span>
<span class="s1">        SELECT id FROM batch WHERE sku=:sku)&#39;&#39;&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;DELETE FROM allocation WHERE orderline_id in (</span>
<span class="s1">        SELECT id FROM order_line WHERE sku=:sku)&#39;&#39;&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM order_line WHERE sku=:sku&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM batch WHERE sku=:sku&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM product WHERE sku=:sku&quot;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">uow_with_product</span><span class="p">(</span><span class="n">get_session</span><span class="p">):</span>
    <span class="n">_sku</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">sku</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">product_version</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">_sku</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sku</span><span class="p">:</span>
            <span class="n">sku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">()</span>
        <span class="n">_sku</span> <span class="o">=</span> <span class="n">sku</span> <span class="c1"># 클린업을 위해 sku 기억</span>
        <span class="n">uow</span> <span class="o">=</span> <span class="n">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="n">random_batchref</span><span class="p">(),</span> <span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">batches</span><span class="o">=</span><span class="p">[</span><span class="n">batch</span><span class="p">],</span> <span class="n">version_number</span><span class="o">=</span><span class="n">product_version</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">uow</span>

    <span class="n">cleanup_sku</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">_sku</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">wrapper</span>
    <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">cleanup_sku</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">_sku</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>이 픽스처를 이용해 <code class="docutils literal notranslate"><span class="pre">try_to_allocate</span></code> 사용법을 테스트해봅시다.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_try_to_allocate</span><span class="p">(</span><span class="n">uow_with_product</span><span class="p">):</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="s1">&#39;TEST-SKU&#39;</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">uow_with_product</span><span class="p">(</span><span class="n">sku</span><span class="p">,</span> <span class="n">product_version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">try_to_allocate</span><span class="p">(</span><span class="n">uow</span><span class="p">,</span> <span class="s1">&#39;TEST-ORDER&#39;</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">)</span>

    <span class="p">[[</span><span class="n">version_number</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT version_number FROM product WHERE sku=:sku&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>

    <span class="p">[[</span><span class="n">qty</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT _purchased_quantity FROM batch WHERE sku=:sku&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">))</span>

    <span class="k">assert</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">version_number</span>
    <span class="k">assert</span> <span class="mi">100</span> <span class="o">==</span> <span class="n">qty</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;batch qty is mismatched: 0 !== </span><span class="si">{</span><span class="n">qty</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="c1">#@mytest.test</span>
<span class="k">def</span> <span class="nf">test_cleanup_completed</span><span class="p">(</span><span class="n">get_session</span><span class="p">):</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM allocation&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM order_line&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM batch&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM product&#39;</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_cleanup_completed</span><span class="p">(</span><span class="n">get_session</span><span class="p">):</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="p">[[</span><span class="n">product_cnt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT count(*) FROM product&#39;</span><span class="p">)</span>
    <span class="p">[[</span><span class="n">batch_cnt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT count(*) FROM batch&#39;</span><span class="p">)</span>
    <span class="p">[[</span><span class="n">alloc_cnt</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT count(*) FROM allocation&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">product_cnt</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">batch_cnt</span>
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">alloc_cnt</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
❌ <span class="ansi-red-intense-fg">test_try_to_allocate</span>
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Traceback (most recent call last):
  File &#34;/home/ykkim/conda/envs/lab/lib/python3.9/site-packages/sqlalchemy/orm/mapper.py&#34;, line 1289, in _configure_class_instrumentation
    raise sa_exc.ArgumentError(
sqlalchemy.exc.ArgumentError: Class &#39;&lt;class &#39;app.domain.models.OrderLine&#39;&gt;&#39; already has a primary mapper defined. Use non_primary=True to create a non primary Mapper.  clear_mappers() will remove *all* current mappers from all classes.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_cleanup_completed</span>
</pre></div></div>
</div>
<p>이제 드디어 동시성 테스트를 해볼 차례입니다.</p>
<ol class="arabic simple">
<li><p>스레드 2개로 동시에 제품 버전정보를 얻고 주문선에 배치를 할당하도록 할 것입니다.</p></li>
<li><p>배치 할당이 완료되면 각 스레드에서 동시에 버전을 업데이트 하려 할 것입니다.</p></li>
<li><p>두 스레드 중 한 스레드만 업데이트에 성공하여 버전을 1만 증가한 상태가 됩니다.</p></li>
<li><p>나머지 스레드는 업데이트 에러 발생하여 예외 상태가 됩니다.</p></li>
</ol>
<p>이 작업을 테스트 코드로 작성해서 실행해보겠습니다.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">threading</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">test</span>
<span class="k">def</span> <span class="nf">test_concurrent_updates_to_version_are_not_allowed</span><span class="p">(</span><span class="n">uow_with_product</span><span class="p">,</span> <span class="n">get_session</span><span class="p">):</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">random_sku</span><span class="p">()</span>
    <span class="n">uow</span> <span class="o">=</span> <span class="n">uow_with_product</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">order1</span><span class="p">,</span> <span class="n">order2</span> <span class="o">=</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">random_orderid</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Exception]</span>
    <span class="k">def</span> <span class="nf">try_to_allocate_order</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">temp_uow</span> <span class="o">=</span> <span class="n">SqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">get_session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> \
            <span class="n">try_to_allocate</span><span class="p">(</span><span class="n">temp_uow</span><span class="p">,</span> <span class="n">order1</span><span class="p">,</span> <span class="n">sku</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">))</span>

    <span class="c1"># 두 스레드가 배치에 동시에 주문선을 할당 후 버전을 업데이트 하려는 상황을 시뮬레이션합니다.</span>
    <span class="n">thread1</span><span class="p">,</span> <span class="n">thread2</span> <span class="o">=</span> <span class="n">try_to_allocate_order</span><span class="p">(</span><span class="n">order1</span><span class="p">),</span> <span class="n">try_to_allocate_order</span><span class="p">(</span><span class="n">order2</span><span class="p">)</span>
    <span class="n">thread1</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">thread2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">thread1</span><span class="o">.</span><span class="n">join</span><span class="p">(),</span> <span class="n">thread2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">get_session</span><span class="p">()</span>
    <span class="p">[[</span><span class="n">version</span><span class="p">]]</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT version_number FROM product WHERE sku=:sku&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># 두 스레드가 동시에 할당을 시도했지만 오직 한 스레드만 성공하여 버전은 한 번만 증가합니다.</span>
    <span class="k">assert</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="p">[</span><span class="n">exception</span><span class="p">]</span> <span class="o">=</span> <span class="n">exceptions</span>
    <span class="k">assert</span> <span class="s1">&#39;could not serialize access due to concurrent update&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>

    <span class="n">orders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;SELECT orderid FROM allocation&quot;</span>
        <span class="s2">&quot; JOIN batch ON allocation.batch_id = batch.id&quot;</span>
        <span class="s2">&quot; JOIN order_line ON allocation.orderline_id = order_line.id&quot;</span>
        <span class="s2">&quot; WHERE order_line.sku=:sku&quot;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">with</span> <span class="n">uow</span><span class="p">:</span>
        <span class="n">uow</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select 1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
❌ <span class="ansi-red-intense-fg">test_concurrent_updates_to_version_are_not_allowed</span>
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Traceback (most recent call last):
  File &#34;&lt;ipython-input-28-fb4d46c3a766&gt;&#34;, line 28, in test_concurrent_updates_to_version_are_not_allowed
    [exception] = exceptions
ValueError: not enough values to unpack (expected 1, got 0)
</pre></div></div>
</div>
<p>그런데, 테스트가 실패했습니다. 예외가 발생할 것이라고 생각했는데 아무런 예외도 발생하지 않았기 때문입니다. 사실 당연합니다. 지금까지 동시 업데이트 시도에 대한 예외처리 코드를 작성하지 않았기 때문입니다.</p>
<p>SQL 표준으로 제정된 격리 레벨을 이용하면 이런 변경 충돌을 쉽게 처리할 수 있습니다.</p>
<p><code class="docutils literal notranslate"><span class="pre">REPEATABLE</span> <span class="pre">READ</span></code> 격리 모드는 다른 트랜잭션이 커밋한 데이터를 읽지 못하도록 격리시키는 모드로, 위 테스트에서 한 트랜잭션이 <code class="docutils literal notranslate"><span class="pre">version_number</span></code>를 증가시키면 다른 트랜잭션은 더이상 이 값을 읽지 못하여 에러가 발생합니다.</p>
<ul>
<li><p><em>See also</em>:</p>
<p>격리 레벨(Isolation Level)에 대해서는 <a class="reference external" href="https://postgresql.kr/docs/11/transaction-iso.html">PostgreSQL 관련 문서</a> 를 참고하세요</p>
</li>
</ul>
<p>이제 격리 레벨을 지원하도록 <code class="docutils literal notranslate"><span class="pre">get_session</span></code> 픽스처를 변경한 뒤 다시 테스트 해보겠습니다.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">get_session</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span><span class="p">,</span> <span class="n">Session</span>
    <span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">config</span>
    <span class="n">orm</span><span class="o">.</span><span class="n">clear_mappers</span><span class="p">()</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">init_engine</span><span class="p">(</span><span class="n">start_mappers</span><span class="p">(),</span> <span class="n">config</span><span class="o">.</span><span class="n">get_db_url</span><span class="p">(),</span> <span class="n">isolation_level</span><span class="o">=</span><span class="s2">&quot;REPEATABLE READ&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

<span class="n">mytest</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test_concurrent_updates_to_version_are_not_allowed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_concurrent_updates_to_version_are_not_allowed</span>
</pre></div></div>
</div>
<p>테스트가 잘 성공함을 알 수 있습니다.</p>
<p>비관적인 동시성 제어방법을 사용할 수 도 있습니다. 동시에 두 트랜잭션이 동일 SKU에 대한 <code class="docutils literal notranslate"><span class="pre">Product</span></code> 를 가져올 수 없도록 락을 걸어 막는 방법입니다.</p>
<p>이 방법을 사용하면 한 트랜잭션이 커밋후 락을 릴리즈하기 전까지 다른 트랜잭션은 대기하게 됩니다. 이 방법을 사용하면 별도의 예외처리는 필요하지 않겠지만 대신 성능 저하가 발생할 것입니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">PessimisticSqlAlchemyProductRepository</span><span class="p">(</span><span class="n">SqlAlchemyProductRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sku</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Product</span><span class="p">)</span> \
                           <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">)</span> \
                           <span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span> \
                           <span class="o">.</span><span class="n">first</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">PessimisticSqlAlchemyUnitOfWork</span><span class="p">(</span><span class="n">SqlAlchemyUnitOfWork</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span>  <span class="c1"># type: Session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">products</span> <span class="o">=</span> <span class="n">PessimisticSqlAlchemyProductRepository</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Wrap-Up">
<h2>Wrap-Up<a class="headerlink" href="#Wrap-Up" title="Permalink to this headline">¶</a></h2>
<p>이번 챕터의 후반부에서 동시성 제어 구현에 너무 치중했던 감이 있습니다. 초심으로 돌아와, 챕터 초반에 논의했던 Aggregate의 개념을 되짚으며 이 장을 마무리해봅시다.</p>
<p>Aggregate는 특정 컨텍스트의 관점에서 여러 도메인 객체들을 일관성의 경계에 따라 묶어놓은 논리 모델이며, 원소들의 불변성과 비즈니스 규칙을 담당하도록 했습니다.</p>
<p>상황에 따라 올바른 Aggregate를 선택하는 것이 중요합니다. 시간이 지나며 상황에 맞춰 재검토가 필요할 수도 있습니다.</p>
<p>더 상세한 내용을 알고 싶다면, Red Book의 저자인 본 버논의 Aggregate 설계에 관한 온라인 논문들을 읽기를 추천합니다.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<script type="application/vnd.jupyter.widget-state+json">
{"state": {}, "version_major": 2, "version_minor": 0}
</script></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../config.html" class="btn btn-neutral float-right" title="config" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="06.html" class="btn btn-neutral float-left" title="06. Unit of Work Pattern" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Joseph Kim &lt;cloudeyes@gmail.com&gt;

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>