

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>02. Repository Pattern &mdash; 2021 Microservices Architecture Study  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="03. Coupling and Abstractions" href="03.html" />
    <link rel="prev" title="01. Domain Modeling" href="01.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> 2021 Microservices Architecture Study
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="00.html">00. Kick-Off</a></li>
<li class="toctree-l1"><a class="reference internal" href="01.html">01. Domain Modeling</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">02. Repository Pattern</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Prerequisites">Prerequisites</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-folder-structure">The folder structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Install-requirements">Install requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Tests">Tests</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Persisting-Our-Domain-Model">Persisting Our Domain Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Reminder:-Our-Model">Reminder: Our Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-“Normal”-ORM-Way:-Model-Depends-on-ORM">The “Normal” ORM Way: Model Depends on ORM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Inverting-the-Dependency:-ORM-Depends-on-Model">Inverting the Dependency: ORM Depends on Model</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Introducing-the-Repository-Pattern">Introducing the Repository Pattern</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#The-Repository-in-the-Abstract">The Repository in the Abstract</a></li>
<li class="toctree-l3"><a class="reference internal" href="#What-is-the-Trade-Off?">What is the Trade-Off?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Concrete-repository-:-SqlAlchemyRepository">Concrete repository : <code class="docutils literal notranslate"><span class="pre">SqlAlchemyRepository</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#Repository-test-for-saving-an-object">Repository test for saving an object</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Repository-test-for-retrieving-a-complex-object">Repository test for retrieving a complex object</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Building-a-Fake-Repository-for-Tests-is-Now-Trivial!">Building a Fake Repository for Tests is Now Trivial!</a></li>
<li class="toctree-l2"><a class="reference internal" href="#What-is-a-Port-and-What-is-an-Adapter,-in-Python?">What is a Port and What is an Adapter, in Python?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Wrap-Up">Wrap-Up</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="03.html">03. Coupling and Abstractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="04.html">04. Flask API and Service Layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="05.html">05. TDD in High and Low Gears</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../domain.html">domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adapters.html">adapters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services.html">services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routes.html">routes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apps.html">apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">tests</a></li>
</ul>
<p class="caption"><span class="caption-text">Library Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vendor.html">SQLAlchemy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vendor.html#flask">Flask</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">2021 Microservices Architecture Study</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../guide.html">Guide</a> &raquo;</li>
        
      <li>02. Repository Pattern</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/guide/02.ipynb" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="02.-Repository-Pattern">
<h1>02. Repository Pattern<a class="headerlink" href="#02.-Repository-Pattern" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Prerequisites">
<h2>Prerequisites<a class="headerlink" href="#Prerequisites" title="Permalink to this headline">¶</a></h2>
<div class="section" id="The-folder-structure">
<h3>The folder structure<a class="headerlink" href="#The-folder-structure" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>tree -I <span class="s1">&#39;__pycache__|build|images|plantuml*|exports|examples&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">.</span>
├── 02-repository-pattern.ipynb
├── <span class="ansi-blue-intense-fg ansi-bold">app</span>
│   ├── <span class="ansi-blue-intense-fg ansi-bold">domain</span>
│   │   └── models.py
│   ├── __init__.py
│   └── services.py
├── requirements.txt
└── <span class="ansi-blue-intense-fg ansi-bold">tests</span>
    ├── __init__.py
    └── test_models.py

3 directories, 7 files
</pre></div></div>
</div>
</div>
<div class="section" id="Install-requirements">
<h3>Install requirements<a class="headerlink" href="#Install-requirements" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>cat ./requirements.txt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
sqlalchemy
pytest
git+https://github.com/AllanDaemon/mypy.git@0edf1233672117c4555759c5a91461a502ddce5d
</pre></div></div>
</div>
</div>
<div class="section" id="Tests">
<h3>Tests<a class="headerlink" href="#Tests" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>pytest
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-bold">============================= test session starts ==============================</span>
platform linux -- Python 3.9.1, pytest-6.1.2, py-1.10.0, pluggy-0.13.1
rootdir: /home/ykkim/notebooks/2021-msa-study/02-repository-pattern
plugins: flask-1.1.0, anyio-2.0.2
collected 12 items

tests/test_models.py <span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">.</span><span class="ansi-green-fg">                                        [100%]</span>

<span class="ansi-green-fg">============================== </span><span class="ansi-green-intense-fg ansi-bold">12 passed</span><span class="ansi-green-fg"> in 0.04s</span><span class="ansi-green-fg"> ==============================</span>
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>mypy --strict -p app
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
app/services.py:3: <span class="ansi-red-intense-fg ansi-bold">error:</span> Cannot find implementation or library stub for module named &#39;app.domain.models&#39;
app/services.py:3: <span class="ansi-blue-fg">note:</span> See <span class="ansi-underline">https://mypy.readthedocs.io/en/latest/running_mypy.html#missing-imports</span>
app/services.py:10: <span class="ansi-red-intense-fg ansi-bold">error:</span> Returning Any from function declared to return <span class="ansi-bold">&#34;str&#34;</span>
<span class="ansi-red-intense-fg ansi-bold">Found 2 errors in 1 file (checked 2 source files)</span>
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Persisting-Our-Domain-Model">
<h2>Persisting Our Domain Model<a class="headerlink" href="#Persisting-Our-Domain-Model" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="Reminder:-Our-Model">
<h2>Reminder: Our Model<a class="headerlink" href="#Reminder:-Our-Model" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">plantuml</span>

@startuml

allow_mixing
left to right direction

class Order {
    * id: str
}

class OrderLine &lt;&lt; valueobject &gt;&gt; {
    * orderid: str
    * sku: str
    * qty: int
}

class Batch {
    * reference: str
    sku: str
    eta: date
    --
    _purchased_quantity: int
    _allocations: [OrderLine]
}

actor Customer
actor &quot;Purchasing\nDept. User&quot;

Customer --&gt; Order : places
Order::id o--&gt; OrderLine::orderid : &quot;comprises\nmultiple&quot;
Batch::_allocations o--&gt; OrderLine
&quot;Purchasing\nDept. User&quot; --&gt; Batch : &quot;purchases&quot;

@enduml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/guide_02_12_0.svg" src="../_images/guide_02_12_0.svg" /></div>
</div>
<ul class="simple">
<li><p><strong>Product</strong></p>
<ul>
<li><p>identified by <em>SKU</em>(Stock Keeping Unit)</p></li>
</ul>
</li>
<li><p><strong>Order</strong></p>
<ul>
<li><p>identified by an <em>order reference</em></p></li>
<li><p>comprises mutliple <em>order lines</em></p></li>
</ul>
</li>
<li><p><strong>OrderLine</strong></p>
<ul>
<li><p>has a <em>SKU</em> and a <em>quantity</em></p></li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p><strong>Batch</strong></p>
<ul>
<li><p>has a unique ID(<em>reference</em>), a <em>SKU</em>, and a <em>quantity</em></p></li>
<li><p>has an ETA if they are currently shipping</p>
<ul>
<li><p>or they may be in <em>warehouse stock</em>.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul class="simple">
<li><p>When we allocate x units of stock to a batch, the <em>available quantity</em> is reduced by x.</p></li>
</ul>
<div class="section" id="The-“Normal”-ORM-Way:-Model-Depends-on-ORM">
<h3>The “Normal” ORM Way: Model Depends on ORM<a class="headerlink" href="#The-“Normal”-ORM-Way:-Model-Depends-on-ORM" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">plantuml</span>

@startuml

left to right direction

entity Order {
    * **id**: Integer
}

entity Batch {
    * **id**: Integer
    --
    * **reference**: String(255)
    * sku: String(255)
    * qty: Integer
}

entity Allocation {
    * **batch_id**
    * **orderline_id**
}

entity OrderLine {
    * **id**: Integer
    --
    * **order_id: Integer**
    * sku: String(255)
    * qty: Integer
    eta: Date
}


Order::id ||..|{ OrderLine::order_id
OrderLine::id ||..|{ Allocation::orderline_id
Batch::id ||..|{ Allocation::batch_id


@enduml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/guide_02_15_0.svg" src="../_images/guide_02_15_0.svg" /></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">_Order</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;order&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">orderlines</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;_OrderLine&#39;</span><span class="p">,</span> <span class="n">collection_class</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_OrderLine</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;order_line&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">qty</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">orderid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;order.id&#39;</span><span class="p">))</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">_Order</span><span class="p">)</span>

<span class="n">allocation</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;allocation&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;orderline_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;order_line.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;batch_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;batch.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">_Batch</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;batch&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sku</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
    <span class="n">eta</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">)</span>
    <span class="n">_purchased_quantity</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">_allocations</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">_OrderLine</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">allocation</span><span class="p">,</span> <span class="n">collection_class</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">init_engine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">logging</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.engine.base.Engine&quot;</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># temporary memory db</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;CREATE TABLE.*?</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">engine</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">init_engine</span><span class="p">(</span><span class="s1">&#39;sqlite://&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CREATE TABLE &#34;order&#34; (
        id INTEGER NOT NULL,
        PRIMARY KEY (id)
)

CREATE TABLE batch (
        id INTEGER NOT NULL,
        reference VARCHAR(255),
        sku VARCHAR(255),
        eta DATE,
        _purchased_quantity INTEGER,
        PRIMARY KEY (id),
        UNIQUE (reference)
)

CREATE TABLE order_line (
        id INTEGER NOT NULL,
        sku VARCHAR(255),
        qty INTEGER,
        orderid INTEGER,
        PRIMARY KEY (id),
        FOREIGN KEY(orderid) REFERENCES &#34;order&#34; (id)
)

CREATE TABLE allocation (
        orderline_id INTEGER NOT NULL,
        batch_id INTEGER NOT NULL,
        PRIMARY KEY (orderline_id, batch_id),
        FOREIGN KEY(orderline_id) REFERENCES order_line (id),
        FOREIGN KEY(batch_id) REFERENCES batch (id)
)


</pre></div></div>
</div>
</div>
<div class="section" id="Inverting-the-Dependency:-ORM-Depends-on-Model">
<h3>Inverting the Dependency: ORM Depends on Model<a class="headerlink" href="#Inverting-the-Dependency:-ORM-Depends-on-Model" title="Permalink to this headline">¶</a></h3>
<p>Using SQLAlchemy’s “classical mapping”.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">MetaData</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Date</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">relationship</span>
<span class="kn">from</span> <span class="nn">app.domain.models</span> <span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">OrderLine</span>

<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>

<span class="n">order_line</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;order_line&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;qty&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;orderid&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
    <span class="n">extend_existing</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">allocation</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;allocation&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;orderline_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;order_line.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;batch_id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;batch.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">extend_existing</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">batch</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;_purchased_quantity&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sku&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">extend_existing</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">batch_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">Batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;_allocations&#39;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">allocation</span><span class="p">,</span>
                                 <span class="n">collection_class</span><span class="o">=</span><span class="nb">set</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span><span class="p">),</span>
<span class="p">},)</span>

<span class="n">order_line_mapper</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">,</span> <span class="n">order_line</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">AbstractContextManager</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">init_engine</span><span class="p">(</span><span class="s1">&#39;sqlite://&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="c1"># temporary memory db</span>

<span class="n">SqliteSessionMaker</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SessionFactory</span> <span class="o">=</span> <span class="n">AbstractContextManager</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SessionFactory</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;`with session` 블록을 이용한 자동 리소스 반환을 구현합니다.&#39;&#39;&#39;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">SqliteSessionMaker</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CREATE TABLE order_line (
        id INTEGER NOT NULL,
        sku VARCHAR(255),
        qty INTEGER NOT NULL,
        orderid VARCHAR(255),
        PRIMARY KEY (id)
)

CREATE TABLE batch (
        id INTEGER NOT NULL,
        reference VARCHAR(255),
        _purchased_quantity INTEGER,
        sku VARCHAR(255),
        eta DATE,
        PRIMARY KEY (id),
        UNIQUE (reference)
)

CREATE TABLE allocation (
        orderline_id INTEGER NOT NULL,
        batch_id INTEGER NOT NULL,
        PRIMARY KEY (orderline_id, batch_id),
        FOREIGN KEY(orderline_id) REFERENCES order_line (id),
        FOREIGN KEY(batch_id) REFERENCES batch (id)
)


</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">mytest</span>

<span class="n">mytest</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span> <span class="nf">test_orderline_mapper_can_load_lines</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">session</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">        INSERT INTO order_line (orderid, sku, qty) VALUES</span>
<span class="s1">        (&#39;order1&#39;, &#39;RED-CHAIR&#39;, 12),</span>
<span class="s1">        (&#39;order2&#39;, &#39;RED-TABLE&#39;, 13),</span>
<span class="s1">        (&#39;order3&#39;, &#39;BLUE-LIPSTICK&#39;, 14)</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;RED-CHAIR&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
            <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order2&#39;</span><span class="p">,</span> <span class="s1">&#39;RED-TABLE&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
            <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order3&#39;</span><span class="p">,</span> <span class="s1">&#39;BLUE-LIPSTICK&#39;</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="n">expected</span> <span class="o">==</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">OrderLine</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_orderline_mapper_can_load_lines</span>
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span> <span class="nf">test_orderline_mapper_can_save_lines</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">session</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">new_line</span> <span class="o">=</span> <span class="n">OrderLine</span><span class="p">(</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;DECORATIVE-WIDGET&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT orderid, sku, qty FROM order_line&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="p">[(</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span> <span class="s1">&#39;DECORATIVE-WIDGET&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)]</span> <span class="o">==</span> <span class="n">rows</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_orderline_mapper_can_save_lines</span>
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Introducing-the-Repository-Pattern">
<h2>Introducing the Repository Pattern<a class="headerlink" href="#Introducing-the-Repository-Pattern" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>An abstraction over persistent storage.</p></li>
<li><p>Hides details of data access by <em>pretending that all of data is in memory</em>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">ditaa</span> repository-pattern
+----------------------------------------+
|            Application Layer           |
+----------------------------------------+
               |^      /----------------\
               ||------|  Domain Model  |
               ||      |     Objects    |
               V|      \----------------/
+----------------------------------------+
|               Repository               |
+----------------------------------------+
                |
                V
+----------------------------------------+
|              Database Layer            |
+----------------------------------------+
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/guide_02_24_0.svg" src="../_images/guide_02_24_0.svg" /></div>
</div>
<div class="section" id="The-Repository-in-the-Abstract">
<h3>The Repository in the Abstract<a class="headerlink" href="#The-Repository-in-the-Abstract" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">ContextDecorator</span>
<span class="kn">import</span> <span class="nn">abc</span>

<span class="k">class</span> <span class="nc">AbstractRepository</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">ContextDecorator</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="c1"># Alternative approache: using `Protocol`</span>
<span class="k">class</span> <span class="nc">RepositoryProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Batch</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Batch</span><span class="p">]:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="What-is-the-Trade-Off?">
<h3>What is the Trade-Off?<a class="headerlink" href="#What-is-the-Trade-Off?" title="Permalink to this headline">¶</a></h3>
<p>Introducing an extra layer of abstraction, - Will reduce complexity overall - But add complexity locally</p>
<div class="section" id="Concrete-repository-:-SqlAlchemyRepository">
<h4>Concrete repository : <code class="docutils literal notranslate"><span class="pre">SqlAlchemyRepository</span></code><a class="headerlink" href="#Concrete-repository-:-SqlAlchemyRepository" title="Permalink to this headline">¶</a></h4>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="k">class</span> <span class="nc">SqlAlchemyRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="n">Batch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Batch</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Batch</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM allocation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM batch&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;DELETE FROM order_line&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

</pre></div>
</div>
</div>
</div>
<div class="section" id="Repository-test-for-saving-an-object">
<h4>Repository test for saving an object<a class="headerlink" href="#Repository-test-for-saving-an-object" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@mytest</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span> <span class="nf">test_repository_can_save_a_batch</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">session</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s1">&#39;SELECT reference, sku, _purchased_quantity, eta FROM &quot;batch&quot;&#39;</span>
            <span class="p">))</span>
            <span class="k">assert</span> <span class="n">rows</span> <span class="o">==</span> <span class="p">[(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="s2">&quot;RUSTY-SOAPDISH&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_repository_can_save_a_batch</span>
</pre></div></div>
</div>
</div>
<div class="section" id="Repository-test-for-retrieving-a-complex-object">
<h4>Repository test for retrieving a complex object<a class="headerlink" href="#Repository-test-for-retrieving-a-complex-object" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">insert_order_line</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;INSERT INTO order_line (orderid, sku, qty) &#39;</span>
        <span class="s1">&#39;VALUES (:orderid, :sku, 12)&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="n">orderline_id</span><span class="p">],</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT id FROM order_line WHERE orderid=:orderid AND sku=:sku&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">orderline_id</span>


<span class="k">def</span> <span class="nf">insert_batch</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;INSERT INTO batch (reference, sku, _purchased_quantity) &#39;</span>
        <span class="s1">&#39;VALUES (:reference, :sku, :qty)&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="n">sku</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="n">qty</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">[</span><span class="n">batch_id</span><span class="p">],</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;SELECT id FROM batch WHERE reference=:reference&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">batch_id</span>


<span class="k">def</span> <span class="nf">insert_allocation</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">orderline_id</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s1">&#39;INSERT INTO allocation (orderline_id, batch_id) &#39;</span>
        <span class="s1">&#39;VALUES (:orderline_id, :batch_id)&#39;</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderline_id</span><span class="o">=</span><span class="n">orderline_id</span><span class="p">,</span> <span class="n">batch_id</span><span class="o">=</span><span class="n">batch_id</span><span class="p">)</span>
    <span class="p">)</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span> <span class="nf">test_repository_can_retrieve_a_batch_with_allocations</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">session</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">SqlAlchemyRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orderline_id</span> <span class="o">=</span> <span class="n">insert_order_line</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="n">batch1_id</span> <span class="o">=</span> <span class="n">insert_batch</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">batch2_id</span> <span class="o">=</span> <span class="n">insert_batch</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s2">&quot;batch2&quot;</span><span class="p">)</span>
            <span class="n">insert_allocation</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">orderline_id</span><span class="p">,</span> <span class="n">batch1_id</span><span class="p">)</span>

            <span class="n">retrieved</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">eta</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">retrieved</span> <span class="o">==</span> <span class="n">expected</span>  <span class="c1"># Batch.__eq__ only compares reference</span>
            <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">sku</span> <span class="o">==</span> <span class="n">expected</span><span class="o">.</span><span class="n">sku</span>
            <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">_purchased_quantity</span> <span class="o">==</span> <span class="n">expected</span><span class="o">.</span><span class="n">_purchased_quantity</span>
            <span class="k">assert</span> <span class="n">retrieved</span><span class="o">.</span><span class="n">_allocations</span> <span class="o">==</span> <span class="p">{</span>
                <span class="n">OrderLine</span><span class="p">(</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="s2">&quot;GENERIC-SOFA&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_repository_can_retrieve_a_batch_with_allocations</span>
</pre></div></div>
</div>
</div>
</div>
</div>
<div class="section" id="Building-a-Fake-Repository-for-Tests-is-Now-Trivial!">
<h2>Building a Fake Repository for Tests is Now Trivial!<a class="headerlink" href="#Building-a-Fake-Repository-for-Tests-is-Now-Trivial!" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">FakeRepository</span><span class="p">(</span><span class="n">AbstractRepository</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batches</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">reference</span> <span class="o">==</span> <span class="n">reference</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batches</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batches</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">fake_repo</span><span class="p">():</span>
    <span class="n">batch1</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-TABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">batch2</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch2&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-CHAIR&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">batch3</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;batch3&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-CABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">FakeRepository</span><span class="p">([</span><span class="n">batch1</span><span class="p">,</span> <span class="n">batch2</span><span class="p">,</span> <span class="n">batch3</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">fake_request_params</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order1&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-TABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order2&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-TABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order3&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-CHAIR&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">30</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">orderid</span><span class="o">=</span><span class="s2">&quot;order4&quot;</span><span class="p">,</span> <span class="n">sku</span><span class="o">=</span><span class="s2">&quot;TEST-CABLE&quot;</span><span class="p">,</span> <span class="n">qty</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">app.services</span> <span class="kn">import</span> <span class="n">allocate</span>

<span class="nd">@mytest</span><span class="o">.</span><span class="n">unit</span>
<span class="k">def</span> <span class="nf">test_fake_repo</span><span class="p">(</span><span class="n">fake_repo</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">fake_request_params</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">session</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">batches</span> <span class="o">=</span> <span class="n">fake_repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">OrderLine</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;orderid&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;sku&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="s1">&#39;qty&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">fake_request_params</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">allocate</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
✅ <span class="ansi-magenta-intense-fg">test_fake_repo</span>
</pre></div></div>
</div>
</div>
<div class="section" id="What-is-a-Port-and-What-is-an-Adapter,-in-Python?">
<h2>What is a Port and What is an Adapter, in Python?<a class="headerlink" href="#What-is-a-Port-and-What-is-an-Adapter,-in-Python?" title="Permalink to this headline">¶</a></h2>
<p>Ports and adapters came out of the OO world - <strong>port</strong> : an interface between our application and whatever we wish to abstract away - <strong>adapter</strong> : an implementation behind that interface or abstraction.</p>
<p>Python doesn’t have interfaces, so defining a port can be simulated with <code class="docutils literal notranslate"><span class="pre">abc.ABC</span></code> or <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>.</p>
<p>In this chapter, - port : <code class="docutils literal notranslate"><span class="pre">AbstractRepository</span></code>. - adapters : <code class="docutils literal notranslate"><span class="pre">SqlAlchemyRepository</span></code> and <code class="docutils literal notranslate"><span class="pre">FakeRepository</span></code>.</p>
</div>
<div class="section" id="Wrap-Up">
<h2>Wrap-Up<a class="headerlink" href="#Wrap-Up" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Summerize the costs and benefits of each architectural pattern we introduce.</p></li>
<li><p>Every single application <em>DO NOT</em> need to be built this way</p>
<ul>
<li><p>Make sure the overall complexity of the repository pattern makes it worth in adding extra layers of indirection.</p></li>
<li><p>If your app is just a simple CRUD wrapper around a database, then YOU DON’T NEED a domain model or a repository.</p></li>
</ul>
</li>
</ul>
<table><thead><tr style="font-size: 14px"><th><p>Pros</p>
</th><th><p>Cons</p>
</th></tr></thead><tbody><tr><td style="width: 50%; vertical-align: top"><ul style="font-size: 14px"><li><p>We have a simple interface between persistent storage and our domain model.</p>
</li><li><p>It’s easy to make a fake version of the repository for unit testing, or to swap out different storage solutions, because we’ve fully decoupled the model from infrastructure concerns.</p>
</li><li><p>Writing the domain model before thinking about persistence helps us focus on the business problem at hand. If we ever want to radically change our approach, we can do that in our model, without needing to worry about foreign keys or migrations until later.</p>
</li><li><p>Our database schema is really simple because we have complete control over how we map our objects to tables.</p>
</li></ul></td><td style="width: 50%; vertical-align: top"><ul style="font-size: 14px"><li><p>An ORM already buys you some decoupling. Changing foreign keys might be hard, but it should be pretty easy to swap between MySQL and Postgres if you ever need to.</p>
</li><li><p>Maintaining ORM mappings by hand requires extra work and extra code.</p>
</li><li><p>Any extra layer of indirection always increases maintenance costs and adds a “WTF factor” for Python programmers who’ve never seen the Repository pattern before.</p>
</li></ul></td></tbody></table><img alt="guide/images/apwp_0206.png" src="guide/images/apwp_0206.png" />
<p>Our domain model should be free of infrastructure concerns, so your ORM should import your model, and not the other way around.</p>
<p>The repository gives you the illusion of a collection of in-memory objects. It makes it easy to create a FakeRepository for testing and to swap fundamental details of your infrastructure without disrupting your core application. See [appendix_csvs] for an example.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="03.html" class="btn btn-neutral float-right" title="03. Coupling and Abstractions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="01.html" class="btn btn-neutral float-left" title="01. Domain Modeling" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Joseph Kim &lt;cloudeyes@gmail.com&gt;

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>